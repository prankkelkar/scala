version: ~> 1.0 # needed for imports

import: scala/scala-dev:travis/default.yml

language: scala

stages:
  - name: build

jobs:
    include:

      # full bootstrap and publish
      - stage: build
        if: type != pull_request
        script:
          # see comment in `bootstrap_fun` for details on the procedure
          # env available in each stage
          #  - by travis config (see below): secret env vars
          #  - by `common` script: WORKSPACE, IVY2_DIR, SBT_CMD, integrationRepoUrl
          #  - by `bootstrap_fun`: publishPrivateTask, ...
          - set -e
          - (cd admin && ./init.sh)
          - source scripts/common
          - source scripts/bootstrap_fun
          - determineScalaVersion
          - removeExistingBuilds $integrationRepoUrl
          - if [ ! -z "$STARR_REF" ]; then buildStarr; fi
          - buildLocker
          - buildQuick
          - triggerScalaDist
          - sbt -Dscala.build.compileWithDotty=true library/compile

      # pull request validation (w/ mini-bootstrap)
      - stage: build
        name: "JDK 8 pr validation"
        if: type = pull_request
        script:
          - set -e
          - sbt -warn setupPublishCore generateBuildCharacterPropertiesFile headerCheck publishLocal
          - STARR=`cat buildcharacter.properties | grep ^maven.version.number | cut -d= -f2` && echo $STARR
          - sbt -Dstarr.version=$STARR -warn setupValidateTest test:compile info testAll
          - sbt -Dscala.build.compileWithDotty=true library/compile

      # build the spec using jekyll
      - stage: build
        language: ruby
        install:
          - ruby -v
          - gem install bundler
          - bundler --version
          - bundle install
        script:
          - set -e
          - 'if [ "$TRAVIS_PULL_REQUEST" = "false" ]; then (cd admin && ./init.sh); fi'
          - bundle exec jekyll build -s spec/ -d build/spec
        after_success:
          - 'if [ "$TRAVIS_PULL_REQUEST" = "false" ]; then ./scripts/travis-publish-spec.sh; fi'

env:
  global:
    - ADOPTOPENJDK=8

# caching for sdkman / sbt / ivy / coursier imported from scala-dev
cache:
  directories:
    - $HOME/.rvm
    
branches:
  only:
  - s390x-travis
notifications:
  webhooks: https://scala-ci.typesafe.com/benchq/webhooks/travis
